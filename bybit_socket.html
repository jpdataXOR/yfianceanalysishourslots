<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bybit Spot – Top 30 by $ Volume → Sort by |% Change| (USDT only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; }
    header { padding: 12px 16px; background: #0b5cff; color: #fff; }
    main { padding: 16px; position: relative; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    input[type="text"] { width: 520px; max-width: 100%; padding: 8px; font-family: monospace; }
    button { padding: 8px 12px; }
    .small { font-size: 12px; opacity: 0.9; }
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      text-align: right;
    }
    th:first-child, td:first-child { text-align: left; }
    th {
      background: #f2f5ff;
      position: sticky;
      top: 0;
      font-weight: bold;
      color: #333;
    }
    tbody tr:hover { background-color: #f5f5f5; }
    .pos { color: #0a7c0a; }
    .neg { color: #b00020; }
    .chart-btn { padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
    }
    .modal-content {
      background-color: #fefefe; padding: 20px; border: 1px solid #888;
      width: 840px; max-width: 95%; border-radius: 8px;
    }
    .close-button {
      color: #aaa; float: right; font-size: 28px; font-weight: bold;
      cursor: pointer; line-height: 1;
    }
    @media (prefers-color-scheme: dark) {
      th, td { border-color: #444; }
      th { background: #2a2a3a; color: #eee; }
      tbody tr:hover { background-color: #333; }
      .modal-content { background-color: #222; }
    }
  </style>
  <!-- pako for inflating binary frames when params.binary=true -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
  <header>
    <strong>Bybit Spot – USDT Markets</strong>
    <div class="small">
      Pipeline: Filter <code>.*USDT</code> → pick <b>Top 30 \ by Dollar Volume</b> (<code>c × qv</code>) → 
      <b>sort those 20</b> by absolute % change (|m| × 100). Table refreshes live.
    </div>
  </header>

  <main>
    <div class="controls">
      <input id="endpoint" type="text" style="display: none;"
             value="wss://ws2.bybit.com/spot/ws/quote/v2?timestamp=" />
      <button id="btnConnect" style="display: none;">Connect</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
      <span id="status-console" class="small" style="line-height: 30px; padding-left: 8px;"></span>
    </div>

    <table id="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Symbol</th>
          <th>Last (c)</th>
          <th>High (h)</th>
          <th>Low (l)</th>
          <th>Base Vol (v)</th>
          <th>Quote Vol (qv)</th>
          <th>Dollar Vol (c×qv)</th>
          <th>% Change (m)</th>
          <th>|% Change|</th>          
          <th>Chart</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>

  <script>
    // ---- Modal ----
    const modal = document.createElement('div');
    modal.id = 'tv-modal';
    modal.className = 'modal';
    modal.innerHTML = `<div class="modal-content"><span class="close-button">&times;</span><div id="tv-widget-container"></div></div>`;
    document.body.appendChild(modal);
    let hoverTimeout = null;
    let activeHoverRow = null;
    const tvWidgetContainer = modal.querySelector('#tv-widget-container');
    modal.querySelector('.close-button').onclick = () => { modal.style.display = 'none'; tvWidgetContainer.innerHTML = ''; };
    // ---- State ----
    let ws = null;
    const allSymbols = new Map();       // symbol -> last raw ticker fields
    let top20Set = new Set();           // the current membership (symbols) of Top 20 by $ volume
    const USDT_REGEX = /USDT$/i;
    const TOP_N = 30;

    // ---- DOM helpers ----
    const $ = id => document.getElementById(id);
    const statusConsole = $('status-console');
    const tbody = $('tbody');

    // ---- numeric helpers ----
    function pctFromM(m) {
      const num = Number(m);
      if (!isFinite(num)) return null;
      return num * 100; // -0.0867 -> -8.67%
    }
    function n(x) {
      const v = Number(x);
      return isFinite(v) ? v : NaN;
    }
    function fmt(x, dp = 2) {
      const v = Number(x);
      if (!isFinite(v)) return x ?? '';
      return v.toLocaleString(undefined, {
        minimumFractionDigits: dp, maximumFractionDigits: dp
      });
    }
    function dollarVolume(tk) {
      // Per your spec: Dollar Vol = close price (c) × quote volume (qv)
      const c = n(tk.c);
      const qv = n(tk.qv);
      if (!isFinite(c) || !isFinite(qv)) return NaN;
      return c * qv;
    }

    /**
     * Step 1: Determine the Top 20 by Dollar Volume (membership only).
     * We recompute this membership on each update.
     */
    function computeTop20Membership() {
      const candidates = [];
      for (const d of allSymbols.values()) {
        if (!USDT_REGEX.test(d.s)) continue;
        const dv = dollarVolume(d);
        if (isFinite(dv)) {
          candidates.push({ sym: d.s, dv });
        }
      }
      candidates.sort((a, b) => b.dv - a.dv);
      const newTop = new Set(candidates.slice(0, TOP_N).map(x => x.sym));
      top20Set = newTop; // replace membership
    }

    /**
     * Step 2: Render the table.
     * Only include rows whose symbol is in top20Set, then sort those rows by |% change| desc.
     */
    function renderFromTop20Membership() {
      const subset = [];
      for (const sym of top20Set) {
        const d = allSymbols.get(sym);
        if (!d) continue;
        const pct = pctFromM(d.m);
        const absPct = pct == null ? NaN : Math.abs(pct);
        const dv = dollarVolume(d);
        subset.push({ ...d, pct, absPct, dv });
      }

      // Sort the selected Top-20 by absolute % change (no change to membership)
      subset.sort((a, b) => {
        const A = isFinite(a.absPct) ? a.absPct : -Infinity;
        const B = isFinite(b.absPct) ? b.absPct : -Infinity;
        return B - A;
      });

      // Render table
      const frag = document.createDocumentFragment();
      subset.forEach((d, i) => {
        const tr = document.createElement('tr');
        const pctClass = (d.pct ?? 0) >= 0 ? 'pos' : 'neg';
        tr.dataset.symbol = d.s;
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${d.s ?? ''}</td>
          <td>${fmt(d.c)}</td>
          <td>${fmt(d.h)}</td>
          <td>${fmt(d.l)}</td>
          <td>${fmt(d.v, 2)}</td>
          <td>${fmt(d.qv, 2)}</td>
          <td>${isFinite(d.dv) ? fmt(d.dv, 2) : ''}</td>
          <td class="${pctClass}">${d.pct == null ? '' : d.pct.toFixed(2) + '%'}</td>
          <td>${isFinite(d.absPct) ? d.absPct.toFixed(2) + '%' : ''}</td>          
          <td><button class="chart-btn" data-symbol="${d.s}">View Chart</button></td>
        `;
        frag.appendChild(tr);
      });
      tbody.innerHTML = '';
      tbody.appendChild(frag);
    }

    function showTradingViewWidget(symbol) {
      tvWidgetContainer.innerHTML = ''; // Clear previous widget
      const widgetConfig = {
        "allow_symbol_change": false, "calendar": false, "details": false,
        "hide_side_toolbar": true, "hide_top_toolbar": true, "hide_legend": false,
        "hide_volume": true, "hotlist": false, "interval": "60", "locale": "en",
        "save_image": false, "style": "1", "symbol": `BYBIT:${symbol}`,
        "theme": window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light",
        "timezone": "Etc/UTC", "backgroundColor": "rgba(255, 224, 178, 1)",
        "gridColor": "rgba(242, 54, 69, 0.06)", "watchlist": [], "withdateranges": false,
        "compareSymbols": [], "studies": ["STD;Supertrend"], "width": 800, "height": 540
      };
      const script = document.createElement('script');
      script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
      script.async = true;
      script.innerHTML = JSON.stringify(widgetConfig);
      tvWidgetContainer.appendChild(script);
      modal.style.display = 'flex';
    }

    function updateStatus(message) {
      if (statusConsole) statusConsole.textContent = message;
    }

    // ---- WebSocket handling ----
    async function handleMessage(evData) {
      try {
        let jsonStr;
        if (typeof evData === 'string') {
          if (evData.includes('"pong"')) return; // Ignore pong responses
          jsonStr = evData;
        } else {
          const buf = evData instanceof Blob
            ? new Uint8Array(await evData.arrayBuffer())
            : new Uint8Array(evData);
          jsonStr = pako.inflate(buf, { to: 'string' });
        }
        const msg = JSON.parse(jsonStr);

        // Data may be array or single object
        const items = Array.isArray(msg.data) ? msg.data : [msg.data ?? msg];

        for (const d of items) {
          if (d && d.s) {
            // Track the latest snapshot for each symbol
            allSymbols.set(d.s, {
              s: d.s, c: d.c, h: d.h, l: d.l, v: d.v, qv: d.qv, m: d.m
            });
          }
        }

        // Pipeline: compute membership by $ volume → render sorted by |%|
        computeTop20Membership();
        renderFromTop20Membership();

      } catch { /* silent */ }
    }

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      updateStatus('Connecting...');
      const base = $('endpoint').value.trim() || 'wss://ws2.bybit.com/spot/ws/quote/v2?timestamp=';
      const url = base.endsWith('=') ? (base + Date.now()) : base;

      ws = new WebSocket(url);
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        updateStatus('Connected');
        $('btnDisconnect').disabled = false;
        // Subscribe to ticker_s with binary=true
        ws.send(JSON.stringify({ topic: 'ticker_s', event: 'sub', params: { binary: true } }));
        setInterval(() => {
          if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ ping: Date.now() }));
        }, 20000);
      };
      ws.onmessage = ev => { handleMessage(ev.data); };
      ws.onclose = () => { $('btnDisconnect').disabled = true; };
      ws.onerror = () => { /* silent */ };
    }

    function disconnect() {
      if (ws) {
        ws.close(1000, 'client disconnect');
        updateStatus('Disconnecting...');
        ws = null;
        $('btnDisconnect').disabled = true;
        setTimeout(() => updateStatus('Disconnected'), 1000);
      }
    }

    $('btnDisconnect').addEventListener('click', disconnect);

    // Event delegation for chart buttons
    $('table').addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('chart-btn')) {
        showTradingViewWidget(e.target.dataset.symbol);
      }
    });

    // Event delegation for row hover
    tbody.addEventListener('mouseover', (e) => {
      const row = e.target.closest('tr');
      if (row && row.dataset.symbol) {
        activeHoverRow = row;
        hoverTimeout = setTimeout(() => {
          if (activeHoverRow === row) { // Check if still hovering on the same row
            showTradingViewWidget(row.dataset.symbol);
          }
        }, 2000);
      }
    });
    tbody.addEventListener('mouseout', () => {
      clearTimeout(hoverTimeout);
      activeHoverRow = null;
    });

    // Auto-connect on page load
    document.addEventListener('DOMContentLoaded', () => {
      connect();
      window.onclick = (event) => {
        if (event.target == modal) {
          modal.style.display = "none";
          tvWidgetContainer.innerHTML = '';
        }
      }
    });
  </script>
</body>
</html>